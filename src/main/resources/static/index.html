<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Meal & Workout Buddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-100">
<header class="bg-blue-600 text-white py-4">
    <div class="max-w-4xl mx-auto flex justify-between items-center px-4">
        <h1 class="text-xl font-bold">Meal & Workout Buddy</h1>
        <button id="logoutBtn"
                class="text-sm bg-white text-blue-700 px-3 py-1 rounded-md font-semibold hover:bg-blue-100">
            Logout
        </button>
    </div>
</header>

<main class="max-w-4xl mx-auto px-4 py-6 grid gap-6 md:grid-cols-2">
    <!-- Left: Form -->
    <section class="bg-white shadow rounded-xl p-5 space-y-4">
        <h2 class="text-lg font-semibold mb-2">Tell me about your goals</h2>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="goal">
                Fitness Goal
            </label>
            <select id="goal"
                    class="w-full border rounded-md px-3 py-2">
                <option value="lose weight">Lose weight</option>
                <option value="build muscle">Build muscle</option>
                <option value="get lean and toned">Get lean and toned</option>
                <option value="improve general fitness">Improve general fitness</option>
            </select>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="daysPerWeek">
                Days per week you can work out
            </label>
            <input id="daysPerWeek" type="number" min="1" max="7" value="4"
                   class="w-full border rounded-md px-3 py-2">
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="equipment">
                Available equipment
            </label>
            <input id="equipment" type="text"
                   placeholder="Dumbbells, resistance bands, no equipment, gym access, etc."
                   class="w-full border rounded-md px-3 py-2">
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="diet">
                Diet preference
            </label>
            <input id="diet" type="text"
                   placeholder="e.g., vegetarian, halal, high-protein, no preference"
                   class="w-full border rounded-md px-3 py-2">
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="notes">
                Extra notes (injuries, timing, etc.)
            </label>
            <textarea id="notes" rows="3"
                      class="w-full border rounded-md px-3 py-2"
                      placeholder="Knee pain, only evenings, beginner level, etc."></textarea>
        </div>

        <button id="generateBtn"
                class="w-full bg-blue-600 text-white font-semibold py-2 rounded-md hover:bg-blue-700">
            Generate Plan
        </button>

        <p id="status" class="text-sm text-gray-600"></p>
    </section>

    <!-- Right: Plan display + save + history -->
    <section class="space-y-4">
        <div class="bg-white shadow rounded-xl p-5">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-semibold">Your 7-Day Plan</h2>
            </div>
            <div id="planContainer" class="prose max-w-none text-sm text-gray-800">
                <p class="text-gray-500 text-sm">Fill the form and click "Generate Plan".</p>
            </div>

            <div class="mt-4 space-y-2">
                <input id="planTitle" type="text"
                       class="w-full border rounded-md px-3 py-2 text-sm"
                       placeholder="Title for this plan (e.g., Spring Cut Plan)">
                <button id="saveBtn"
                        class="w-full bg-emerald-600 text-white font-semibold py-2 rounded-md hover:bg-emerald-700">
                    Save this Plan
                </button>
                <p id="saveStatus" class="text-sm text-gray-600"></p>
            </div>
        </div>

        <div class="bg-white shadow rounded-xl p-5">
            <h2 class="text-lg font-semibold mb-2">My Saved Plans</h2>
            <div id="savedPlans" class="space-y-2 text-sm text-gray-800">
                <p class="text-gray-500 text-sm">No plans loaded yet.</p>
            </div>
        </div>
    </section>
</main>

<script>
    let lastPlanHtml = '';
    let lastFormData = {};

    async function generatePlan() {
        const goal = document.getElementById('goal').value;
        const daysPerWeek = document.getElementById('daysPerWeek').value;
        const equipment = document.getElementById('equipment').value;
        const diet = document.getElementById('diet').value;
        const notes = document.getElementById('notes').value;

        document.getElementById('status').textContent = 'Generating plan with AI...';
        document.getElementById('planContainer').innerHTML = '';

        lastFormData = {goal, daysPerWeek, equipment, diet, notes};

        try {
            const resp = await fetch('/api/generate-plan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(lastFormData)
            });

            if (!resp.ok) {
                const text = await resp.text();
                document.getElementById('status').textContent =
                    'Error: ' + (text || resp.status);
                return;
            }

            const html = await resp.text();
            lastPlanHtml = html;
            document.getElementById('planContainer').innerHTML = html;
            document.getElementById('status').textContent = 'Plan generated!';
        } catch (e) {
            document.getElementById('status').textContent =
                'Error contacting server.';
        }
    }

    async function savePlan() {
        if (!lastPlanHtml) {
            document.getElementById('saveStatus').textContent =
                'Generate a plan before saving.';
            return;
        }

        const title = document.getElementById('planTitle').value.trim() || 'My Workout Plan';

        const payload = {
            title,
            goal: lastFormData.goal,
            daysPerWeek: lastFormData.daysPerWeek,
            equipment: lastFormData.equipment,
            diet: lastFormData.diet,
            planText: lastPlanHtml
        };

        document.getElementById('saveStatus').textContent = 'Saving...';

        try {
            const resp = await fetch('/api/plans', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (resp.ok) {
                document.getElementById('saveStatus').textContent = 'Plan saved!';
                loadPlans();
            } else {
                document.getElementById('saveStatus').textContent = 'Could not save plan.';
            }
        } catch (e) {
            document.getElementById('saveStatus').textContent = 'Error saving plan.';
        }
    }

    async function loadPlans() {
        const container = document.getElementById('savedPlans');
        container.innerHTML = '<p class="text-gray-500 text-sm">Loading...</p>';

        try {
            const resp = await fetch('/api/plans');
            if (!resp.ok) {
                container.innerHTML = '<p class="text-red-600 text-sm">Error loading plans.</p>';
                return;
            }

            const plans = await resp.json();
            if (plans.length === 0) {
                container.innerHTML =
                    '<p class="text-gray-500 text-sm">No saved plans yet.</p>';
                return;
            }

            container.innerHTML = '';
            plans.forEach(p => {
                const div = document.createElement('div');
                div.className = 'border rounded-md p-2';
                div.innerHTML = `
                    <div class="font-semibold">${p.title}</div>
                    <div class="text-xs text-gray-500 mb-1">${p.goal} â€¢ ${p.daysPerWeek} days/week</div>
                    <details class="mt-1">
                        <summary class="text-xs text-blue-700 cursor-pointer">View plan</summary>
                        <div class="mt-2 text-sm border-t pt-2">${p.planText}</div>
                    </details>
                `;
                container.appendChild(div);
            });

        } catch (e) {
            container.innerHTML = '<p class="text-red-600 text-sm">Error loading plans.</p>';
        }
    }

    async function logout() {
        await fetch('/api/logout', {method: 'POST'});
        window.location.href = '/login.html';
    }

    document.getElementById('generateBtn').addEventListener('click', generatePlan);
    document.getElementById('saveBtn').addEventListener('click', savePlan);
    document.getElementById('logoutBtn').addEventListener('click', logout);

    // Load saved plans on page load
    loadPlans();
</script>

</body>
</html>
